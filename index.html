<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset='utf-8' />
    <title>Reserva de Armaios</title>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <style>
        /* ... (los estilos se mantienen igual, sin cambios) ... */
    </style>
</head>
<body>
    <div id="calendar-container">
        <h1>Reserva de Armaios</h1>

        <div class="configuracion-reserva">
            <div class="form-container">
                <h2 class="section-title">Nueva Reserva</h2>

                <!-- ... (el resto del formulario se mantiene igual) ... -->

            </div>

            <div class="normas-container">
                <h2 class="section-title">Normas del Profesorado</h2>
                <!-- ... (contenido de normas) ... -->
            </div>
        </div>

        <div id='calendar'></div>
    </div>

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.min.js'></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar que FullCalendar está cargado
            if (typeof FullCalendar === 'undefined') {
                alert('Error: No se pudo cargar la biblioteca FullCalendar. Verifica tu conexión a internet.');
                return;
            }

            var calendarEl = document.getElementById('calendar');
            if (!calendarEl) {
                alert('Error: No se encontró el elemento del calendario');
                return;
            }

            var btnReservar = document.getElementById('btn-reservar');
            var errorMessageEl = document.getElementById('error-message');
            var successMessageEl = document.getElementById('success-message');

            // Mapeo de horarios
            const horarios = {
                '8:05-9:00': { start: '08:05', end: '09:00' },
                '9:00-9:55': { start: '09:00', end: '09:55' },
                '9:55-10:50': { start: '09:55', end: '10:50' },
                '11:20-12:15': { start: '11:20', end: '12:15' },
                '12:15-13:10': { start: '12:15', end: '13:10' },
                '13:10-14:05': { start: '13:10', end: '14:05' }
            };

            // Configuración del calendario
            var calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'es',
                initialView: 'timeGridWeek',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek'
                },
                views: {
                    timeGridWeek: {
                        buttonText: 'Semana Laboral',
                        slotMinTime: '07:00:00',
                        slotMaxTime: '15:00:00',
                        slotLabelInterval: '01:00:00',
                        slotLabelFormat: {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        },
                        weekends: false,
                        dayHeaderFormat: { weekday: 'short', day: 'numeric', month: 'short' }
                    },
                    dayGridMonth: {
                        buttonText: 'Mes',
                        weekends: true,
                        dayHeaderFormat: { weekday: 'short' },
                        eventLimit: 6,
                        moreLinkClick: 'week',
                        moreLinkText: 'más'
                    }
                },
                allDaySlot: false,
                slotDuration: '00:15:00',
                firstDay: 1,
                nowIndicator: true,
                selectable: false,
                eventContent: function(arg) {
                    if (arg.view.type === 'dayGridMonth') {
                        return {
                            html: `<div class="fc-event-title">${arg.event.extendedProps.profesor}</div>
                                   <div class="fc-event-armario">${arg.event.extendedProps.armario}</div>
                                   <div class="fc-event-horario">${arg.event.extendedProps.horario}</div>`
                        };
                    } else {
                        return {
                            html: `<div class="fc-event-title">${arg.event.extendedProps.profesor}</div>
                                   <div class="fc-event-armario">${arg.event.extendedProps.armario}</div>
                                   <div class="fc-event-aula">${arg.event.extendedProps.aula}</div>
                                   <div class="fc-event-grupo">${arg.event.extendedProps.grupo}</div>
                                   <div class="fc-event-horario">${arg.event.extendedProps.horario}</div>`
                        };
                    }
                },
                eventClick: function(info) {
                    if (confirm(`¿Eliminar reserva de ${info.event.extendedProps.profesor}?`)) {
                        info.event.remove();
                        showMessage('Reserva eliminada', 'success');
                    }
                },
                eventColor: function(arg) {
                    if (arg.event.extendedProps.armario === 'AR-111') {
                        return '#3498db';
                    } else if (arg.event.extendedProps.armario === 'AR-114') {
                        return '#2ecc71';
                    } else if (arg.event.extendedProps.armario === 'ARM-01') {
                        return '#FFD700';
                    }
                }
            });

            calendar.render();

            function checkFormValidity() {
                var isValid = (
                    document.getElementById('select-armario').value &&
                    document.getElementById('select-horario').value &&
                    document.getElementById('select-aula').value &&
                    document.getElementById('select-grupo').value &&
                    document.getElementById('nombre-profesor').value.trim().length >= 1 &&
                    document.getElementById('select-fecha').value
                );
                btnReservar.disabled = !isValid;
            }

            document.querySelectorAll('select, input').forEach(el => {
                el.addEventListener('change', checkFormValidity);
            });
            document.getElementById('nombre-profesor').addEventListener('input', checkFormValidity);

            btnReservar.addEventListener('click', function() {
                hideMessages();

                var armario = document.getElementById('select-armario').value;
                var horario = document.getElementById('select-horario').value;
                var aula = document.getElementById('select-aula').value;
                var grupo = document.getElementById('select-grupo').value;
                var nombreProfesor = document.getElementById('nombre-profesor').value.trim();
                var fecha = document.getElementById('select-fecha').value;

                if (!horarios[horario]) {
                    showMessage('Seleccione un horario válido', 'error');
                    return;
                }

                var startTime = horarios[horario].start.split(':');
                var endTime = horarios[horario].end.split(':');

                var startDate = new Date(fecha);
                startDate.setHours(parseInt(startTime[0]), parseInt(startTime[1]), 0, 0);

                var endDate = new Date(startDate);
                endDate.setHours(parseInt(endTime[0]), parseInt(endTime[1]), 0, 0);

                var eventos = calendar.getEvents();
                var conflicto = eventos.some(event => {
                    return event.extendedProps.armario === armario &&
                           ((event.start <= startDate && event.end > startDate) ||
                            (event.start < endDate && event.end >= endDate));
                });

                if (conflicto) {
                    showMessage(`${armario} ya está reservado en este horario`, 'error');
                    return;
                }

                calendar.addEvent({
                    title: `${nombreProfesor}`,
                    start: startDate,
                    end: endDate,
                    extendedProps: {
                        armario: armario,
                        aula: aula,
                        horario: horario,
                        grupo: grupo,
                        profesor: nombreProfesor
                    },
                    color: armario === 'AR-111' ? '#3498db' : armario === 'AR-114' ? '#2ecc71' : '#FFD700'
                });

                showMessage(`Reserva confirmada para ${nombreProfesor}`, 'success');
            });

            function showMessage(message, type) {
                hideMessages();
                var el = type === 'error' ? errorMessageEl : successMessageEl;
                el.textContent = message;
                el.style.display = 'block';
            }

            function hideMessages() {
                errorMessageEl.style.display = 'none';
                successMessageEl.style.display = 'none';
            }
        });
    </script>
</body>
</html>
